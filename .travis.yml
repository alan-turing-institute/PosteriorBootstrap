language: r
warnings_are_errors: true

# Use Xenial whenever running in Linux (ignored for OS X)

# Disable lintr-bot comments by default
env:
  - LINTR_COMMENT_BOT=false

# Disable LaTeX installation which often fails on OSX
latex: false

# Construct the job matrix of OS, distribution and R versions
os:
  - linux
dist:
  - focal
  - xenial
r:
  - oldrel
  - release
  - devel

# Specify any additional packages that might be needed
# Note that we need a V8 engine for RStan
addons:
  apt:
    update: true
    packages:
    - libv8-dev
  homebrew:
    packages:
    - llvm
    - v8

# OSX: Ensure that R will use clang from homebrew llvm (which includes openmp support)
before_install:
  - |
    if [ "${TRAVIS_OS_NAME}" == "osx" ]; then
      mkdir -p ~/.R
      echo "CC=$(brew --prefix llvm)/bin/clang" > ~/.R/Makevars
      echo "CXX=$(brew --prefix llvm)/bin/clang++" >> ~/.R/Makevars
      echo "LDFLAGS=-L$(brew --prefix llvm)/lib" >> ~/.R/Makevars
    fi

# Explicitly enable the lintr-bot for one build (this avoids duplicate comments).
# Travis treats builds with different environment variables as different builds.
# We therefore remove the one we don't want in order to replace it with the one
# we do.
jobs:
  exclude:
    - os: linux
      r: release
      env: LINTR_COMMENT_BOT=false
  include:
    - os: linux
      r: release
      env: LINTR_COMMENT_BOT=true

# Add R packages from CRAN. If newer versions are needed, r_github_packages
# can be used instead
r_packages:
  - covr
  - lintr

after_success:
  - Rscript -e 'covr::codecov()'
